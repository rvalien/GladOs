name: Deploy to Production

on:
  push:
    branches:
      - release/prod
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: cd-prod
    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "üöÄ Starting deployment..."
            cd ${{ secrets.PROD_APP_PATH }}
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git fetch --all --tags
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "üìã Current branch: $CURRENT_BRANCH"
            
            # –ü—É–ª–ª–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git pull origin $CURRENT_BRANCH
            
            # –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üê≥ Building Docker images..."
            docker compose build backend --build-arg COMPOSE_TAG=v${{ github.event.inputs.version }}
            
            echo "üîÑ Starting services..."
            docker compose up -d
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ Deployment completed!"
            docker compose ps

      - name: Notify Success
        if: success()
        run: |
          echo "üéâ Deployment —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
          echo "–í–µ—Ç–∫–∞: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"