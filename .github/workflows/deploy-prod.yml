name: Deploy to Production
on:
  push:
    branches:
      - release/prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: cd-prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Extract version from commit message
        id: get_version
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" =~ \[RELEASE-v([0-9]+\.[0-9]+(\.[0-9]+)?)\] ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "–ù–∞–π–¥–µ–Ω–∞ –≤–µ—Ä—Å–∏—è –≤ commit: $VERSION"
          else
            VERSION="latest"
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è latest"
          fi
          echo "version=$VERSION" >> $GITHUB_ENV

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: TELEGRAM_TOKEN,WEATHER_TOKEN,RELEASE_VERSION
          script: |
            cd ${{ secrets.PROD_APP_PATH }}
            git pull origin release/prod

            export TELEGRAM_TOKEN="$TELEGRAM_TOKEN"
            export WEATHER_TOKEN="$WEATHER_TOKEN" 
            export RELEASE_VERSION="${{ env.version }}"
            
            # –°—Ç—Ä–æ–∏–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
            docker compose build --build-arg RELEASE_VERSION="$RELEASE_VERSION" backend
            docker compose up -d
        env:
          WEATHER_TOKEN: ${{ secrets.WEATHER_TOKEN }}
          RELEASE_VERSION: ${{ env.version }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

      - name: Notify Deployment Success
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ‚úÖ *Deployment Successful*

            üè∑Ô∏è *Version*: `v${{ env.version }}`
            üéØ *Environment*: Production

            üöÄ Application has been deployed successfully!